<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8" />
    <title>flight</title>

    <script src="https://unpkg.com/deck.gl@^9.0.0-beta.5/dist.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" />
    <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
      }

      #map {
        flex-grow: 1;
      }
    </style>
  </head>

  <body>
    <h1>{{ flight.date }}</h1>
    <p>{{ flight.duration }}</p>
    <div id="map"></div>
  </body>

  <script defer>
    // This key is domain-restricted, don't even try.
    const API_KEY = "J9HxCuZ903G6MABPdFn6";
    const map = (window.map = new maplibregl.Map({
        container: "map",
        zoom: 12,
        center: {{ flight.geojson["coordinates"][0] }},
        pitch: 50,
        hash: true,
        style: {
            version: 8,
            sources: {
                maptiler_planet: {
                    url: `https://api.maptiler.com/tiles/v3/tiles.json?key=${API_KEY}`,
                    type: "vector"
                },
                satellite: {
                    url: `https://api.maptiler.com/tiles/satellite-v2/tiles.json?key=${API_KEY}`,
                    type: "raster"
                },
                terrainSource: {
                    type: "raster-dem",
                    url: `https://api.maptiler.com/tiles/terrain-rgb-v2/tiles.json?key=${API_KEY}`,
                    tileSize: 256
                },
                hillshadeSource: {
                    type: "raster-dem",
                    url: `https://api.maptiler.com/tiles/terrain-rgb-v2/tiles.json?key=${API_KEY}`,
                    tileSize: 256
                },
            },
            glyphs: `https://api.maptiler.com/fonts/{fontstack}/{range}.pbf?key=${API_KEY}`,
            sprite: "https://api.maptiler.com/maps/outdoor-v2/sprite",
            layers: [
                {
                    id: "satellite",
                    type: "raster",
                    source: "satellite"
                },
                {
                    id: "hills",
                    type: "hillshade",
                    source: "hillshadeSource",
                    layout: { visibility: "visible" },
                    paint: { "hillshade-shadow-color": "#473B24" }
                },
                // Taken from MapTiler Outdoor style
                // See https://cloud.maptiler.com/maps/outdoor-v2/
                {"id":"Peak labels","type":"symbol","source":"maptiler_planet","source-layer":"mountain_peak","minzoom":9,"maxzoom":22,"layout":{"icon-size":["interpolate",["linear",1],["zoom"],9,["case",["==",["get","rank"],1],0.9,0.7],14,["case",["==",["get","rank"],1],1,0.8]],"text-font":["Roboto Condensed Regular","Noto Sans Regular"],"text-size":["interpolate",["exponential",1],["zoom"],7,9,11,10,13,13],"icon-image":"triangle","text-field":["concat",["coalesce",["get","name:en"],["get","name"]],"\n",["get","ele"]," m"],"visibility":"visible","text-anchor":"top","text-offset":[0,0.7],"text-max-width":{"stops":[[12,4],[15,4]]}},"paint":{"icon-color":"hsl(23, 57%, 24%)","text-color":"hsl(23, 57%, 24%)","icon-halo-blur":0.2,"text-halo-blur":{"stops":[[11,2],[15,0]]},"icon-halo-color":"hsl(0, 0%, 100%)","icon-halo-width":["interpolate",["linear"],["zoom"],9,1,14,1.5],"text-halo-color":"hsl(0, 0%, 100%)","text-halo-width":["interpolate",["linear"],["zoom"],9,1,14,1.5]},"filter":["all",["==","$type","Point"],["in","class","peak"],["has","name"],["!has","customary_ft"]]},
                {"id":"Town labels","type":"symbol","source":"maptiler_planet","source-layer":"place","minzoom":6,"maxzoom":16,"layout":{"icon-size":0.7,"text-font":["Roboto Medium","Noto Sans Regular"],"text-size":["interpolate",["linear",1],["zoom"],6,["case",["<=",["get","rank"],12],11,10],9,["case",["<=",["get","rank"],15],13,12],16,["case",["<=",["get","rank"],15],22,20]],"icon-image":"dot","text-field":["coalesce",["get","name:en"],["get","name"]],"visibility":"visible","icon-anchor":"top","text-anchor":"bottom","text-offset":[0,0.1],"text-max-width":8},"paint":{"icon-color":"hsl(0, 0%, 100%)","text-color":"hsl(240, 6%, 13%)","icon-halo-blur":0,"icon-halo-color":"hsl(0, 0%, 35%)","icon-halo-width":1,"text-halo-color":"hsla(0, 100%, 100%, 0.8)","text-halo-width":1.6},"metadata":{},"filter":["==","class","town"]},
                {"id":"City labels","type":"symbol","source":"maptiler_planet","source-layer":"place","minzoom":5,"maxzoom":16,"layout":{"icon-size":["interpolate",["linear",1],["zoom"],6,["match",["get","capital"],2,0.7,0.6],14,["match",["get","capital"],2,0.9,0.7]],"text-font":["Roboto Medium","Noto Sans Regular"],"text-size":["interpolate",["linear",1],["zoom"],5,["case",["==",["get","capital"],2],16,12],7,["case",["==",["get","capital"],2],18,14],9,["case",["==",["get","capital"],2],25,22],11,["case",["==",["get","capital"],2],28,24]],"icon-image":"circle-dot","text-field":"{name:en}","visibility":"visible","icon-offset":["interpolate",["linear"],["zoom"],6,["literal",[0,0]],10,["literal",[0,-2]]],"text-anchor":"bottom","text-padding":2,"icon-optional":false,"text-max-width":8,"symbol-sort-key":["to-number",["get","rank"]],"icon-allow-overlap":false},"paint":{"text-color":"hsl(240, 6%, 13%)","text-translate":[0,-2],"icon-halo-color":"hsl(0, 0%, 100%)","icon-halo-width":1,"text-halo-color":"hsla(0, 100%, 100%, 0.8)","text-halo-width":1.6},"metadata":{},"filter":["==","class","city"]},
                {"id":"Village labels","type":"symbol","source":"maptiler_planet","source-layer":"place","minzoom":8,"maxzoom":22,"layout":{"icon-size":0.5,"text-font":["Roboto Regular","Noto Sans Regular"],"text-size":["interpolate",["linear",1],["zoom"],11,12,16,18],"icon-image":"dot","text-field":"{name}","visibility":"visible","text-anchor":"bottom","text-offset":[0,-0.2],"text-max-width":8,"text-transform":"none","icon-allow-overlap":true,"text-letter-spacing":0},"paint":{"icon-color":"hsl(0, 0%, 100%)","text-color":"hsl(240, 6%, 13%)","icon-halo-blur":0,"icon-halo-color":"hsl(0, 0%, 35%)","icon-halo-width":1,"text-halo-color":"hsla(0, 100%, 100%, 0.8)","text-halo-width":1.6},"filter":["==","class","village"]},
            ],
            terrain: {
                source: "terrainSource",
                exaggeration: 1
            }
        },
        maxZoom: 18,
        maxPitch: 80
    }));

    map.addControl(new maplibregl.FullscreenControl());

    map.addControl(
        new maplibregl.NavigationControl({
            visualizePitch: true,
            showZoom: true,
            showCompass: true
        })
    );

    map.addControl(
        new maplibregl.TerrainControl({
            source: "terrainSource",
            exaggeration: 1
        })
    );

    const {MapboxOverlay, PathLayer} = deck;
    const deckOverlay = new MapboxOverlay({
        interleaved: true,
        layers: [
            new PathLayer({
                id: "PathLayer",
                data: [{{ flight.geojson | json_encode() }}],
                getColor: [255, 0, 0],
                getPath: d => d["coordinates"],
                capRounded: true,
                jointRounded: true,
                widthMinPixels: 1,
                widthMaxPixels: 5,
                billboard: true,
            })
        ]
      });

      map.addControl(deckOverlay);
  </script>

</html>
